<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${isEdit} ? 'Edit Field' : 'Add New Field'"></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .header {
            background-color: #dc3545;
            color: white;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .header h1 {
            margin: 0;
        }
        .nav-btn {
            background-color: #6c757d;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 5px;
            float: right;
            margin-left: 10px;
        }
        .content {
            background-color: white;
            padding: 30px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            max-width: 800px;
            margin: 0 auto;
        }
        .options-panel {
            display: none;
        }
        .option-row {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .btn-remove-option {
            margin-top: 28px;
        }
        .form-check-input {
            width: 20px;
            height: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 th:text="${isEdit} ? 'Edit Field' : 'Add New Field'"></h1>
        <a href="/admin/dashboard" class="nav-btn">‚Üê Back to Dashboard</a>
        <a href="/logout" class="nav-btn">Logout</a>
    </div>
    
    <div class="content">
        <!-- Messages -->
        <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
        <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>
        
        <!-- Form -->
        <form th:action="${isEdit} ? @{/admin/fields/update/{id}(id=${field.id})} : @{/admin/fields/save}" 
              method="post" id="fieldForm">
            
            <div class="mb-3">
                <label for="fieldName" class="form-label">
                    Field Name <span class="text-danger">*</span>
                </label>
                <input type="text" id="fieldName" name="fieldName" 
                       class="form-control" required 
                       placeholder="e.g., Full Name, Email, Department"
                       th:value="${field.fieldName}">
            </div>
            
            <div class="mb-3">
                <label for="fieldType" class="form-label">
                    Field Type <span class="text-danger">*</span>
                </label>
                <select id="fieldType" name="fieldType" class="form-control" required
                        onchange="toggleOptionsPanel()">
                    <option value="">Select a field type</option>
                    <option th:each="type : ${fieldTypes}" 
                            th:value="${type}" 
                            th:text="${type}"
                            th:selected="${field.fieldType == type}">
                    </option>
                </select>
            </div>
            
            <div class="mb-3">
                <label for="targetRole" class="form-label">
                    Target Role <span class="text-danger">*</span>
                </label>
                <select id="targetRole" name="targetRole" class="form-control" required>
                    <option value="">Select a role</option>
                    <option th:each="role : ${targetRoles}" 
                            th:value="${role}" 
                            th:text="${role}"
                            th:selected="${field.targetRole == role}">
                    </option>
                </select>
            </div>
            
            <div class="mb-3">
                <div class="form-check">
                    <input type="checkbox" id="isRequired" name="isRequired"
                           class="form-check-input" th:checked="${field.isRequired}">
                    <label for="isRequired" class="form-check-label">
                        Required Field
                    </label>
                </div>
            </div>
            
            <!-- Options Panel for DROPDOWN type -->
            <div id="optionsPanel" class="options-panel mb-3">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Dropdown Options</h5>
                    </div>
                    <div class="card-body">
                        <div id="optionsContainer">
                            <!-- Existing options will be loaded here -->
                            <div th:each="option, stat : ${options}" class="option-row">
                                <div class="row">
                                    <div class="col-md-5">
                                        <input type="text" class="form-control" 
                                               th:name="optionValues[]"
                                               th:value="${option.optionValue}"
                                               placeholder="Option Value" required>
                                    </div>
                                    <div class="col-md-5">
                                        <input type="text" class="form-control" 
                                               th:name="displayLabels[]"
                                               th:value="${option.displayLabel}"
                                               placeholder="Display Label" required>
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-danger btn-sm btn-remove-option" 
        onclick="removeOption(this)">
    Remove
</button>
                                        <input type="hidden" th:name="deleteOptionIds[]" 
                                               th:value="${option.id}">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary mt-2" onclick="addOption()">
                            + Add Option
                        </button>
                        <p class="text-muted mt-2 mb-0">
                            <small>Note: Option Value is stored in database, Display Label is shown to users</small>
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="form-actions mt-4">
                <button type="submit" class="btn btn-primary" 
                        th:text="${isEdit} ? 'Update Field' : 'Create Field'">
                    Save
                </button>
                <a href="/admin/dashboard" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>

    <script>
    // Toggle options panel based on field type
    function toggleOptionsPanel() {
        const fieldType = document.getElementById('fieldType').value;
        const optionsPanel = document.getElementById('optionsPanel');
        const optionInputs = document.querySelectorAll('input[name="optionValues[]"], input[name="displayLabels[]"]');
        
        if (fieldType === 'DROPDOWN') {
            optionsPanel.style.display = 'block';
            // Ensure at least one option exists
            if (document.querySelectorAll('.option-row').length === 0) {
                addOption();
            }
            // Enable inputs
            optionInputs.forEach(input => {
                input.removeAttribute('disabled');
                input.required = true;
            });
        } else {
            optionsPanel.style.display = 'none';
            // Disable inputs completely
            optionInputs.forEach(input => {
                input.setAttribute('disabled', 'disabled');
                input.required = false;
            });
        }
    }
    
    // Add new option row
    function addOption() {
        const container = document.getElementById('optionsContainer');
        const row = document.createElement('div');
        row.className = 'option-row mb-2';
        row.innerHTML = `
            <div class="row">
                <div class="col-md-5">
                    <input type="text" class="form-control" name="optionValues[]" 
                           placeholder="Option Value">
                </div>
                <div class="col-md-5">
                    <input type="text" class="form-control" name="displayLabels[]" 
                           placeholder="Display Label">
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-danger btn-sm btn-remove-option" 
                            onclick="removeOption(this)">
                        Remove
                    </button>
                </div>
            </div>
        `;
        container.appendChild(row);
        
        // Set initial disabled state
        const fieldType = document.getElementById('fieldType').value;
        if (fieldType !== 'DROPDOWN') {
            row.querySelectorAll('input').forEach(input => {
                input.setAttribute('disabled', 'disabled');
                input.required = false;
            });
        }
    }
    
    // Remove option row
    function removeOption(button) {
        const row = button.closest('.option-row');
        row.remove();
    }
    
    // Check field type on page load
    document.addEventListener('DOMContentLoaded', function() {
        toggleOptionsPanel();
    });
    
    // Form validation - disable option inputs before submission if not DROPDOWN
    document.getElementById('fieldForm').addEventListener('submit', function(e) {
        const fieldType = document.getElementById('fieldType').value;
        const targetRole = document.getElementById('targetRole').value;
        
        // Basic validation
        if (!fieldType || !targetRole) {
            e.preventDefault();
            alert('Please fill all required fields');
            return false;
        }
        
        // Handle option inputs based on field type
        if (fieldType !== 'DROPDOWN') {
            const optionInputs = document.querySelectorAll('input[name="optionValues[]"], input[name="displayLabels[]"]');
            optionInputs.forEach(input => {
                input.setAttribute('disabled', 'disabled');
                input.required = false;
            });
        } else {
            // Validate dropdown options
            const options = document.querySelectorAll('input[name="optionValues[]"]');
            if (options.length === 0) {
                e.preventDefault();
                alert('Please add at least one option for the dropdown');
                return false;
            }
            
            // Validate option values are not empty
            for (let option of options) {
                if (!option.value.trim()) {
                    e.preventDefault();
                    alert('Option values cannot be empty');
                    return false;
                }
            }
        }
        
        return true;
    });
</script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>