<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${isEdit} ? 'Edit Field' : 'Add New Field'"></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #dc3545;
            --secondary-color: #6c757d;
            --info-color: #0dcaf0;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color), #c82333);
            color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            margin: 0;
            font-weight: 600;
            font-size: 1.8rem;
        }
        
        .nav-btn {
            background-color: var(--secondary-color);
            color: white;
            padding: 0.5rem 1.25rem;
            text-decoration: none;
            border-radius: 0.375rem;
            border: none;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        .nav-btn:hover {
            background-color: #5a6268;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        
        .content {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            max-width: 800px;
            margin: 0 auto;
        }
        
        .options-panel {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .option-row {
            background-color: #f8f9fa;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-left: 4px solid var(--info-color);
        }
        
        .form-label.required::after {
            content: " *";
            color: var(--primary-color);
        }
        
        .btn-remove-option {
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        .btn-remove-option:hover {
            opacity: 1;
        }
        
        .validation-message {
            color: var(--primary-color);
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
        }
        
        @media (max-width: 768px) {
            .content {
                padding: 1.5rem;
            }
            
            .header {
                padding: 1rem;
            }
            
            .option-row .col-md-2 {
                margin-top: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="d-flex justify-content-between align-items-center">
            <h1 th:text="${isEdit} ? 'Edit Field' : 'Add New Field'"></h1>
            <div>
                <a href="/admin/dashboard" class="nav-btn me-2">
                    ‚Üê Dashboard
                </a>
                <a href="/logout" class="nav-btn">Logout</a>
            </div>
        </div>
    </div>
    
    <div class="content">
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
            <span th:text="${success}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        
        <form th:action="${isEdit} ? @{/admin/fields/update/{id}(id=${field.id})} : @{/admin/fields/save}" 
              method="post" id="fieldForm" novalidate>
            
            <div class="mb-4">
                <label for="fieldName" class="form-label required">Field Name</label>
                <input type="text" id="fieldName" name="fieldName" 
                       class="form-control" required 
                       placeholder="e.g., Email Address"
                       th:value="${field.fieldName}"
                       aria-describedby="fieldNameHelp">
                <div id="fieldNameHelp" class="form-text">The display name users will see</div>
                <div class="validation-message" id="fieldNameError">Please enter a field name</div>
            </div>
            
            <div class="mb-4">
                <label for="fieldType" class="form-label required">Field Type</label>
                <select id="fieldType" name="fieldType" class="form-select" required>
                    <option value="">Select a field type</option>
                    <option th:each="type : ${fieldTypes}" 
                            th:value="${type}" 
                            th:text="${type}"
                            th:selected="${field.fieldType == type}">
                    </option>
                </select>
                <div class="validation-message" id="fieldTypeError">Please select a field type</div>
            </div>

            <div id="optionsPanel" class="options-panel mb-4">
                <div class="card border-info">
                    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Dropdown Options</h5>
                        <button type="button" class="btn btn-sm btn-light" onclick="addOption()">
                            + Add Option
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="optionsContainer" class="mb-3">
                            <div th:each="option, stat : ${options}" class="option-row">
                                <div class="row g-2 align-items-center">
                                    <div class="col-md-5">
                                        <input type="text" class="form-control" 
                                               name="optionValues[]"
                                               th:value="${option.optionValue}"
                                               placeholder="Option value (e.g., USA)"
                                               data-validate="option-value"
                                               required>
                                        <div class="validation-message">Option value is required</div>
                                    </div>
                                    <div class="col-md-5">
                                        <input type="text" class="form-control" 
                                               name="displayLabels[]"
                                               th:value="${option.displayLabel}"
                                               placeholder="Display label (e.g., United States)"
                                               data-validate="option-label"
                                               required>
                                        <div class="validation-message">Display label is required</div>
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-danger btn-sm w-100" 
                                                onclick="removeOption(this)">
                                            Remove
                                        </button>
                                        <input type="hidden" name="deleteOptionIds[]" 
                                               th:value="${option.id}">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="text-muted">
                            <small>Add values and display labels for each dropdown option</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mb-4">
                <label for="targetRole" class="form-label required">Target Role</label>
                <select id="targetRole" name="targetRole" class="form-select" required>
                    <option value="">Select a role</option>
                    <option th:each="role : ${targetRoles}" 
                            th:value="${role}" 
                            th:text="${role}"
                            th:selected="${field.targetRole == role}">
                    </option>
                </select>
                <div class="form-text">Which user role will see this field</div>
                <div class="validation-message" id="targetRoleError">Please select a target role</div>
            </div>
            
            <div class="mb-4">
                <div class="form-check form-switch">
                    <input type="checkbox" id="isRequired" name="isRequired"
                           class="form-check-input" role="switch"
                           th:checked="${field.isRequired}">
                    <label for="isRequired" class="form-check-label">
                        Required Field
                    </label>
                </div>
                <div class="form-text">Users must fill this field</div>
            </div>
            
            <div class="d-flex gap-2 mt-4 pt-3 border-top">
                <button type="submit" class="btn btn-primary px-4" 
                        th:text="${isEdit} ? 'Update Field' : 'Create Field'">
                </button>
                <a href="/admin/dashboard" class="btn btn-outline-secondary">Cancel</a>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        class FieldFormManager {
            constructor() {
                this.form = document.getElementById('fieldForm');
                this.fieldTypeSelect = document.getElementById('fieldType');
                this.optionsPanel = document.getElementById('optionsPanel');
                this.optionsContainer = document.getElementById('optionsContainer');
                
                this.init();
            }
            
            init() {
                this.fieldTypeSelect.addEventListener('change', () => this.toggleOptionsPanel());
                this.form.addEventListener('submit', (e) => this.validateForm(e));
                
                this.toggleOptionsPanel();
                
                this.addValidationListeners();
            }
            
            toggleOptionsPanel() {
                const isDropdown = this.fieldTypeSelect.value === 'DROPDOWN';
                
                if (isDropdown) {
                    this.optionsPanel.style.display = 'block';
                    this.enableOptions();
                    
                    if (this.getOptionCount() === 0) {
                        this.addOption();
                    }
                } else {
                    this.optionsPanel.style.display = 'none';
                    this.disableOptions();
                }
            }
            
            enableOptions() {
                const inputs = this.optionsContainer.querySelectorAll('input[type="text"]');
                inputs.forEach(input => {
                    input.disabled = false;
                    input.required = true;
                });
            }
            
            disableOptions() {
                const inputs = this.optionsContainer.querySelectorAll('input[type="text"]');
                inputs.forEach(input => {
                    input.disabled = true;
                    input.required = false;
                });
            }
            
            addOption(optionValue = '', displayLabel = '') {
                const optionId = Date.now() + Math.random();
                const optionRow = document.createElement('div');
                optionRow.className = 'option-row mb-2';
                optionRow.innerHTML = `
                    <div class="row g-2 align-items-center">
                        <div class="col-md-5">
                            <input type="text" class="form-control" 
                                   name="optionValues[]"
                                   value="${optionValue}"
                                   placeholder="Option value"
                                   data-validate="option-value"
                                   required>
                            <div class="validation-message">Option value is required</div>
                        </div>
                        <div class="col-md-5">
                            <input type="text" class="form-control" 
                                   name="displayLabels[]"
                                   value="${displayLabel}"
                                   placeholder="Display label"
                                   data-validate="option-label"
                                   required>
                            <div class="validation-message">Display label is required</div>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-danger btn-sm w-100" 
                                    onclick="fieldFormManager.removeOption(this)">
                                Remove
                            </button>
                        </div>
                    </div>
                `;
                this.optionsContainer.appendChild(optionRow);
                
                // Focus the first input
                optionRow.querySelector('input').focus();
            }
            
            removeOption(button) {
                const optionRow = button.closest('.option-row');
                if (this.getOptionCount() > 1) {
                    optionRow.remove();
                } else {
                    // Clear inputs instead of removing last row
                    const inputs = optionRow.querySelectorAll('input[type="text"]');
                    inputs.forEach(input => input.value = '');
                }
            }
            
            getOptionCount() {
                return this.optionsContainer.querySelectorAll('.option-row').length;
            }
            
            addValidationListeners() {
                const requiredFields = this.form.querySelectorAll('[required]');
                requiredFields.forEach(field => {
                    field.addEventListener('blur', () => this.validateField(field));
                    field.addEventListener('input', () => this.clearFieldError(field));
                });
            }
            
            validateField(field) {
                if (!field.value.trim()) {
                    this.showFieldError(field, 'This field is required');
                    return false;
                }
                this.clearFieldError(field);
                return true;
            }
            
            showFieldError(field, message) {
                const errorDiv = field.nextElementSibling;
                if (errorDiv && errorDiv.classList.contains('validation-message')) {
                    errorDiv.textContent = message;
                    errorDiv.style.display = 'block';
                    field.classList.add('is-invalid');
                }
            }
            
            clearFieldError(field) {
                const errorDiv = field.nextElementSibling;
                if (errorDiv && errorDiv.classList.contains('validation-message')) {
                    errorDiv.style.display = 'none';
                    field.classList.remove('is-invalid');
                }
            }
            
            validateForm(event) {
                let isValid = true;
                
                const requiredFields = this.form.querySelectorAll('[required]:not(:disabled)');
                requiredFields.forEach(field => {
                    if (!this.validateField(field)) {
                        isValid = false;
                    }
                });
                
                if (this.fieldTypeSelect.value === 'DROPDOWN') {
                    const optionValues = this.optionsContainer.querySelectorAll('input[name="optionValues[]"]');
                    
                    if (optionValues.length === 0) {
                        alert('Please add at least one option for the dropdown');
                        isValid = false;
                    }
                    
                    optionValues.forEach(input => {
                        if (!input.value.trim()) {
                            this.showFieldError(input, 'Option value cannot be empty');
                            isValid = false;
                        }
                    });
                }
                
                if (!isValid) {
                    event.preventDefault();
                    const firstError = this.form.querySelector('.is-invalid');
                    if (firstError) {
                        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
                
                return isValid;
            }
        }
        
        let fieldFormManager;
        document.addEventListener('DOMContentLoaded', () => {
            fieldFormManager = new FieldFormManager();
        });
        
        window.addOption = () => fieldFormManager?.addOption();
        window.removeOption = (button) => fieldFormManager?.removeOption(button);
    </script>
</body>
</html>